<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Maze Runner - GameyBoy</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        html, body {
            margin: 0;
            overflow: hidden;
            font-family: 'Press Start 2P', monospace;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        /* Pixel font base */
        .pixel-font {
            font-family: 'Press Start 2P', monospace;
            letter-spacing: -1px;
        }

        /* GameyBoy Device Styles */
        .gameboy-device {
            background: linear-gradient(145deg, #8b8b9b 0%, #6b6b7b 50%, #5a5a6a 100%);
            border-radius: 20px 20px 60px 60px;
            padding: 20px;
            box-shadow:
                inset 0 2px 4px rgba(255,255,255,0.3),
                inset 0 -2px 4px rgba(0,0,0,0.3),
                0 10px 30px rgba(0,0,0,0.5),
                0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .gameboy-device::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 20px;
            right: 20px;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            border-radius: 2px;
        }

        /* Screen bezel */
        .screen-bezel {
            background: linear-gradient(145deg, #2d2d3d 0%, #1a1a2a 100%);
            border-radius: 8px;
            padding: 12px;
            box-shadow:
                inset 0 4px 8px rgba(0,0,0,0.5),
                inset 0 -2px 4px rgba(255,255,255,0.1);
            position: relative;
        }

        .screen-bezel::before {
            content: 'DOT MATRIX WITH STEREO SOUND';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 5px;
            color: #4a4a5a;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        /* LCD Screen effect */
        .lcd-screen {
            background: #9bbc0f;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
        }

        .lcd-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0,0,0,0.03) 2px,
                rgba(0,0,0,0.03) 4px
            );
            pointer-events: none;
            z-index: 10;
        }

        .lcd-screen::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 11;
        }

        /* Screen content colors - Game Boy palette */
        .lcd-screen {
            --gb-darkest: #0f380f;
            --gb-dark: #306230;
            --gb-light: #8bac0f;
            --gb-lightest: #9bbc0f;
        }

        /* Brand text */
        .brand-text {
            color: #3a3a4a;
            font-size: 16px;
            font-style: italic;
            font-weight: bold;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.3);
            font-family: 'Arial Black', sans-serif;
            letter-spacing: 2px;
        }

        .brand-text span {
            color: #2a5298;
        }

        /* Power LED */
        .power-led {
            width: 8px;
            height: 8px;
            background: #333;
            border-radius: 50%;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
        }

        .power-led.on {
            background: #ff3333;
            box-shadow: 0 0 8px #ff3333, inset 0 -1px 2px rgba(0,0,0,0.3);
            animation: led-pulse 2s ease-in-out infinite;
        }

        @keyframes led-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* D-Pad styles */
        .dpad-container {
            width: 100px;
            height: 100px;
            position: relative;
        }

        .dpad {
            position: absolute;
            background: #2a2a3a;
            box-shadow:
                inset 0 -3px 6px rgba(0,0,0,0.4),
                0 2px 4px rgba(0,0,0,0.3);
        }

        .dpad-vertical {
            width: 34px;
            height: 100px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 4px;
        }

        .dpad-horizontal {
            width: 100px;
            height: 34px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 4px;
        }

        .dpad-center {
            position: absolute;
            width: 34px;
            height: 34px;
            background: #3a3a4a;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }

        .dpad-btn {
            position: absolute;
            width: 34px;
            height: 34px;
            background: transparent;
            border: none;
            cursor: pointer;
            z-index: 3;
        }

        .dpad-btn:active {
            background: rgba(0,0,0,0.2);
        }

        .dpad-up { top: 0; left: 50%; transform: translateX(-50%); }
        .dpad-down { bottom: 0; left: 50%; transform: translateX(-50%); }
        .dpad-left { left: 0; top: 50%; transform: translateY(-50%); }
        .dpad-right { right: 0; top: 50%; transform: translateY(-50%); }

        /* Action buttons */
        .action-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(145deg, #8b2252 0%, #6b1242 100%);
            border: none;
            box-shadow:
                inset 0 2px 4px rgba(255,255,255,0.2),
                inset 0 -2px 4px rgba(0,0,0,0.3),
                0 4px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            color: #2a2a3a;
            text-shadow: 0 1px 0 rgba(255,255,255,0.2);
        }

        .action-btn:active {
            box-shadow:
                inset 0 2px 4px rgba(0,0,0,0.3),
                0 2px 4px rgba(0,0,0,0.2);
            transform: translateY(2px);
        }

        .action-btn-b {
            background: linear-gradient(145deg, #8b2252 0%, #6b1242 100%);
        }

        .action-btn-a {
            background: linear-gradient(145deg, #8b2252 0%, #6b1242 100%);
        }

        /* Start/Select buttons */
        .menu-btn {
            width: 40px;
            height: 12px;
            background: #4a4a5a;
            border: none;
            border-radius: 6px;
            box-shadow:
                inset 0 2px 3px rgba(0,0,0,0.4),
                0 1px 2px rgba(0,0,0,0.2);
            cursor: pointer;
            transform: rotate(-25deg);
        }

        .menu-btn:active {
            box-shadow: inset 0 3px 5px rgba(0,0,0,0.5);
        }

        /* Speaker grille */
        .speaker-grille {
            display: flex;
            flex-direction: column;
            gap: 3px;
            transform: rotate(-25deg);
        }

        .speaker-line {
            width: 40px;
            height: 4px;
            background: #3a3a4a;
            border-radius: 2px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
        }

        /* Screen content styling */
        .screen-content {
            color: #0f380f;
            position: relative;
            z-index: 5;
        }

        .screen-content h1, .screen-content h2, .screen-content h3 {
            color: #0f380f;
            text-shadow: 2px 2px 0 #306230;
        }

        .screen-content button {
            background: #306230;
            color: #9bbc0f;
            border: 3px solid #0f380f;
            font-family: 'Press Start 2P', monospace;
            cursor: pointer;
            transition: all 0.1s;
        }

        .screen-content button:hover {
            background: #0f380f;
            color: #9bbc0f;
        }

        .screen-content button:active {
            transform: scale(0.95);
        }

        .screen-content input {
            background: #8bac0f;
            color: #0f380f;
            border: 3px solid #0f380f;
            font-family: 'Press Start 2P', monospace;
        }

        .screen-content input:focus {
            outline: none;
            background: #9bbc0f;
        }

        /* Retro selection cursor */
        .menu-cursor::before {
            content: '►';
            margin-right: 8px;
        }

        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake { animation: shake 0.3s ease-in-out; }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .blink {
            animation: blink 1s step-end infinite;
        }

        #game-canvas {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        /* Mobile optimizations */
        @media (max-width: 640px) {
            .gameboy-device {
                padding: 12px;
                border-radius: 15px 15px 40px 40px;
                max-width: 100vw;
            }
            .screen-bezel {
                padding: 8px;
            }
            .brand-text {
                font-size: 12px;
            }
            .screen-content {
                font-size: 7px;
            }
            .desktop-only { display: none !important; }
            .dpad-container {
                width: 90px;
                height: 90px;
            }
            .dpad-vertical {
                width: 30px;
                height: 90px;
            }
            .dpad-horizontal {
                width: 90px;
                height: 30px;
            }
            .dpad-center, .dpad-btn {
                width: 30px;
                height: 30px;
            }
            .action-btn {
                width: 38px;
                height: 38px;
                font-size: 8px;
            }
        }
        @media (min-width: 641px) {
            .mobile-only { display: none !important; }
        }

        /* Mobile control buttons */
        .mobile-btn {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .mobile-btn:active {
            transform: scale(0.95);
        }

        /* Allow text input selection */
        input[type="text"] {
            -webkit-user-select: text;
            user-select: text;
        }

        /* Leaderboard scrollbar - retro style */
        #leaderboard-list::-webkit-scrollbar {
            width: 8px;
        }
        #leaderboard-list::-webkit-scrollbar-track {
            background: #306230;
        }
        #leaderboard-list::-webkit-scrollbar-thumb {
            background: #0f380f;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2 sm:p-4">
    <!-- Background Music -->
    <audio id="bg-music" src="playdate.mp3" loop preload="auto"></audio>

    <!-- GameyBoy Device Frame -->
    <div class="gameboy-device max-w-md w-full">
        <!-- Brand and Power LED -->
        <div class="flex items-center justify-between mb-3 px-2">
            <div class="brand-text">Gamey<span>Boy</span></div>
            <div class="flex items-center gap-2">
                <span class="text-xs text-gray-600" style="font-family: sans-serif;">POWER</span>
                <div id="power-led" class="power-led on"></div>
            </div>
        </div>

        <!-- Screen Bezel -->
        <div class="screen-bezel mb-4">
            <!-- LCD Screen -->
            <div class="lcd-screen">
                <div id="app" class="screen-content p-3 sm:p-4 relative" style="min-height: 320px;">

                    <!-- Name Entry Screen -->
                    <div id="name-screen" class="flex flex-col items-center justify-center h-full">
                        <h1 class="text-sm sm:text-base mb-1 text-center leading-relaxed">MAZE</h1>
                        <h1 class="text-sm sm:text-base mb-4 text-center leading-relaxed">RUNNER</h1>
                        <div class="w-16 h-1 bg-[#0f380f] mb-4"></div>
                        <p class="text-xs mb-4 text-center">ENTER NAME</p>
                        <input type="text" id="player-name-input" maxlength="10" placeholder="PLAYER"
                            class="px-3 py-2 text-center text-xs mb-4 w-40 uppercase">
                        <button id="start-btn" class="px-6 py-2 text-xs">START</button>
                    </div>

                    <!-- Main Menu -->
                    <div id="menu-screen" class="hidden flex flex-col items-center h-full overflow-y-auto">
                        <h1 class="text-xs sm:text-sm mb-1 text-center">MAZE RUNNER</h1>
                        <p class="text-xs mb-3">Hi, <span id="player-name-display">PLAYER</span>!</p>

                        <div class="border-3 border-[#0f380f] p-2 sm:p-3 mb-3 w-full" style="background: #8bac0f;">
                            <h3 class="text-xs mb-2">HOW TO PLAY</h3>
                            <!-- Desktop controls -->
                            <div class="desktop-only text-xs space-y-1" style="font-size: 6px; line-height: 1.4;">
                                <div>ARROWS/WASD = MOVE</div>
                                <div>SPACE = ATTACK</div>
                                <div>P/ESC = PAUSE</div>
                            </div>
                            <!-- Mobile controls -->
                            <div class="mobile-only text-xs space-y-1" style="font-size: 6px; line-height: 1.4;">
                                <div>D-PAD = MOVE</div>
                                <div>B BTN = ATTACK</div>
                                <div>SELECT = PAUSE</div>
                            </div>
                            <div class="mt-2 pt-2 border-t-2 border-[#0f380f]" style="font-size: 6px;">
                                <p>F=GOAL *=GEM !=PWR X=HAZARD</p>
                            </div>
                        </div>

                        <h3 class="text-xs mb-2">SELECT PLAYER</h3>
                        <div id="characters" class="flex gap-2 mb-3">
                            <button class="character-btn flex flex-col items-center p-2 border-3 border-[#0f380f]" style="background: #8bac0f; min-width: 50px;" data-char="W">
                                <span class="text-lg mb-1">@</span>
                                <span style="font-size: 5px;">WIZARD</span>
                            </button>
                            <button class="character-btn flex flex-col items-center p-2 border-3 border-[#0f380f]" style="background: #8bac0f; min-width: 50px;" data-char="F">
                                <span class="text-lg mb-1">&amp;</span>
                                <span style="font-size: 5px;">FOX</span>
                            </button>
                            <button class="character-btn flex flex-col items-center p-2 border-3 border-[#0f380f]" style="background: #8bac0f; min-width: 50px;" data-char="R">
                                <span class="text-lg mb-1">#</span>
                                <span style="font-size: 5px;">ROBOT</span>
                            </button>
                            <button class="character-btn flex flex-col items-center p-2 border-3 border-[#0f380f]" style="background: #8bac0f; min-width: 50px;" data-char="G">
                                <span class="text-lg mb-1">%</span>
                                <span style="font-size: 5px;">GHOST</span>
                            </button>
                        </div>

                        <button id="play-btn" class="px-6 py-2 text-xs mb-3">► PLAY</button>

                        <p class="text-xs mb-2" style="font-size: 6px;">HIGH SCORE: <span id="high-score">0</span></p>

                        <div class="flex gap-2">
                            <button id="music-toggle" class="px-3 py-1" style="font-size: 6px;">
                                <span id="music-icon">♪</span>
                                <span id="music-text">ON</span>
                            </button>
                            <button id="leaderboard-btn" class="px-3 py-1" style="font-size: 6px;">
                                SCORES
                            </button>
                        </div>
                    </div>

                    <!-- Game Screen -->
                    <div id="game-screen" class="hidden flex flex-col items-center h-full">
                        <!-- HUD -->
                        <div class="flex justify-between items-center w-full mb-1 text-xs" style="font-size: 7px;">
                            <div class="flex gap-2">
                                <span id="score">SC:0000</span>
                                <span id="combo" class="hidden blink">x2!</span>
                            </div>
                            <div class="flex gap-2">
                                <span id="level">LV:01</span>
                                <span id="timer">T:60</span>
                            </div>
                        </div>

                        <div class="relative">
                            <canvas id="game-canvas" class="border-3 border-[#0f380f]"></canvas>

                            <!-- Countdown Overlay -->
                            <div id="countdown" class="hidden absolute inset-0 flex items-center justify-center" style="background: rgba(155,188,15,0.9);">
                                <span class="text-4xl"></span>
                            </div>

                            <!-- Level Complete -->
                            <div id="level-complete" class="hidden absolute inset-0 flex flex-col items-center justify-center p-4" style="background: rgba(155,188,15,0.95);">
                                <h2 class="text-sm mb-2">LEVEL CLEAR!</h2>
                                <p class="text-xs mb-1">BONUS: +<span id="level-bonus">0</span></p>
                                <p class="text-xs" style="font-size: 6px;">NEXT: <span id="next-level-timer">3</span></p>
                            </div>
                        </div>

                        <div class="mt-1">
                            <div id="powerup-display">
                                <span id="speed-indicator" class="hidden text-xs blink" style="font-size: 6px;">!SPEED!</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pause Overlay -->
                    <div id="pause-overlay" class="hidden absolute inset-0 flex flex-col items-center justify-center z-10 p-4" style="background: #9bbc0f;">
                        <h2 class="text-base mb-6">PAUSED</h2>
                        <button id="resume-btn" class="px-6 py-2 text-xs mb-3">► RESUME</button>
                        <button id="quit-btn" class="px-6 py-2 text-xs">QUIT</button>
                    </div>

                    <!-- Game Over -->
                    <div id="game-over" class="hidden absolute inset-0 flex flex-col items-center justify-center z-10 p-4" style="background: #9bbc0f;">
                        <h2 id="game-over-title" class="text-sm mb-4">GAME OVER</h2>
                        <p class="text-xs mb-2">SCORE: <span id="final-score">0</span></p>
                        <p class="text-xs mb-2" style="font-size: 6px;">LEVEL: <span id="final-level">1</span></p>
                        <p id="new-high-score" class="hidden text-xs mb-3 blink">*NEW RECORD*</p>
                        <div class="flex flex-col gap-2">
                            <button id="play-again-btn" class="px-6 py-2 text-xs">► RETRY</button>
                            <button id="menu-btn" class="px-6 py-2 text-xs">MENU</button>
                        </div>
                        <button id="gameover-leaderboard-btn" class="mt-3 px-4 py-1" style="font-size: 6px;">SCORES</button>
                    </div>

                    <!-- Leaderboard Overlay -->
                    <div id="leaderboard-overlay" class="hidden absolute inset-0 flex flex-col items-center z-20 p-3" style="background: #9bbc0f;">
                        <h2 class="text-xs mb-3">HIGH SCORES</h2>
                        <div id="leaderboard-list" class="w-full flex-1 overflow-y-auto mb-3 border-3 border-[#0f380f] p-2" style="background: #8bac0f; max-height: 200px;">
                            <!-- Leaderboard entries will be inserted here -->
                        </div>
                        <button id="close-leaderboard-btn" class="px-6 py-2 text-xs">BACK</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Physical Controls Area -->
        <div class="flex justify-between items-start mt-4 px-2">
            <!-- D-Pad -->
            <div class="dpad-container">
                <div class="dpad dpad-vertical"></div>
                <div class="dpad dpad-horizontal"></div>
                <div class="dpad-center"></div>
                <button class="dpad-btn dpad-up mobile-btn" data-dir="up" aria-label="Up"></button>
                <button class="dpad-btn dpad-down mobile-btn" data-dir="down" aria-label="Down"></button>
                <button class="dpad-btn dpad-left mobile-btn" data-dir="left" aria-label="Left"></button>
                <button class="dpad-btn dpad-right mobile-btn" data-dir="right" aria-label="Right"></button>
            </div>

            <!-- Center: Start/Select -->
            <div class="flex flex-col items-center justify-center gap-4 pt-8">
                <div class="flex gap-4">
                    <div class="flex flex-col items-center gap-1">
                        <button id="select-btn" class="menu-btn mobile-btn" aria-label="Select"></button>
                        <span class="text-xs text-gray-600" style="font-family: sans-serif; font-size: 6px;">SELECT</span>
                    </div>
                    <div class="flex flex-col items-center gap-1">
                        <button id="start-game-btn" class="menu-btn mobile-btn" aria-label="Start"></button>
                        <span class="text-xs text-gray-600" style="font-family: sans-serif; font-size: 6px;">START</span>
                    </div>
                </div>
                <!-- Speaker Grille -->
                <div class="speaker-grille mt-2">
                    <div class="speaker-line"></div>
                    <div class="speaker-line"></div>
                    <div class="speaker-line"></div>
                    <div class="speaker-line"></div>
                    <div class="speaker-line"></div>
                    <div class="speaker-line"></div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center gap-2" style="transform: rotate(-25deg);">
                <div class="flex flex-col items-center gap-1">
                    <button id="btn-b" class="action-btn action-btn-b mobile-btn" data-dir="action" aria-label="B Button">B</button>
                </div>
                <div class="flex flex-col items-center gap-1 -mt-4">
                    <button id="btn-a" class="action-btn action-btn-a mobile-btn" aria-label="A Button">A</button>
                </div>
            </div>
        </div>

        <!-- Mobile Controls (hidden by default, shown via JS) -->
        <div id="mobile-controls" class="hidden"></div>
    </div>

    <script>
        // ===== GAME STATE =====
        const state = {
            canvas: null,
            ctx: null,
            tileSize: 32,
            mazeWidth: 15,
            mazeHeight: 15,
            maze: [],
            player: { x: 1, y: 1, targetX: 1, targetY: 1, animProgress: 1 },
            goal: { x: 13, y: 13 },
            hazards: [],
            collectibles: [],
            powerups: [],
            particles: [],

            character: '@',  // Pixel art character symbol
            characterMap: {
                'W': '@',  // Wizard
                'F': '&',  // Fox
                'R': '#',  // Robot
                'G': '%'   // Ghost
            },
            gameStarted: false,
            gamePaused: false,
            gameOver: false,

            score: 0,
            level: 1,
            timeLeft: 60,
            combo: 0,
            comboTimer: 0,
            lastCollectTime: 0,

            speedBoost: false,
            speedBoostTimer: 0,

            keysPressed: {},
            lastMoveTime: 0,
            moveDelay: 120,

            highScore: parseInt(localStorage.getItem('mazeHighScore') || '0'),
            soundEnabled: true,
            audioCtx: null,

            bgMusic: null,
            musicEnabled: true,
            musicStarted: false,

            isMobile: false,
            touchHoldInterval: null,

            playerName: '',
            leaderboard: [],

            // Game Boy color palette
            gbColors: {
                darkest: '#0f380f',
                dark: '#306230',
                light: '#8bac0f',
                lightest: '#9bbc0f'
            }
        };

        // ===== LEADERBOARD =====
        function loadLeaderboard() {
            try {
                const data = localStorage.getItem('mazeLeaderboard');
                state.leaderboard = data ? JSON.parse(data) : [];
            } catch (e) {
                state.leaderboard = [];
            }
        }

        function saveLeaderboard() {
            try {
                localStorage.setItem('mazeLeaderboard', JSON.stringify(state.leaderboard));
            } catch (e) {
                console.log('Could not save leaderboard');
            }
        }

        function addToLeaderboard(name, score, level) {
            const entry = {
                name: name || 'Anonymous',
                score: score,
                level: level,
                date: new Date().toLocaleDateString()
            };
            state.leaderboard.push(entry);
            // Sort by score descending, keep top 20
            state.leaderboard.sort((a, b) => b.score - a.score);
            state.leaderboard = state.leaderboard.slice(0, 20);
            saveLeaderboard();
        }

        function renderLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            if (state.leaderboard.length === 0) {
                list.innerHTML = '<p class="text-center py-4" style="font-size: 6px; color: #0f380f;">NO SCORES YET</p>';
                return;
            }

            let html = '<div class="space-y-1">';
            state.leaderboard.forEach((entry, index) => {
                const rank = String(index + 1).padStart(2, '0');
                const isCurrentPlayer = entry.name === state.playerName;
                const marker = isCurrentPlayer ? '>' : ' ';
                const scoreStr = String(entry.score).padStart(5, '0');
                html += `
                    <div class="flex justify-between items-center" style="font-size: 6px; color: #0f380f; font-family: 'Press Start 2P', monospace;">
                        <span>${marker}${rank}.${entry.name.substring(0, 8).toUpperCase().padEnd(8, ' ')}</span>
                        <span>${scoreStr} L${entry.level}</span>
                    </div>
                `;
            });
            html += '</div>';
            list.innerHTML = html;
        }

        function showLeaderboard() {
            renderLeaderboard();
            document.getElementById('leaderboard-overlay').classList.remove('hidden');
        }

        function hideLeaderboard() {
            document.getElementById('leaderboard-overlay').classList.add('hidden');
        }

        // ===== AUDIO =====
        function initAudio() {
            state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playTone(freq, duration, type = 'sine', volume = 0.1) {
            if (!state.soundEnabled || !state.audioCtx) return;
            try {
                const osc = state.audioCtx.createOscillator();
                const gain = state.audioCtx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                gain.gain.value = volume;
                gain.gain.exponentialRampToValueAtTime(0.001, state.audioCtx.currentTime + duration);
                osc.connect(gain);
                gain.connect(state.audioCtx.destination);
                osc.start();
                osc.stop(state.audioCtx.currentTime + duration);
            } catch(e) {}
        }

        // Chiptune-style sounds using square waves
        function playMove() { playTone(440, 0.03, 'square', 0.04); }
        function playCollect() {
            playTone(880, 0.08, 'square', 0.08);
            setTimeout(() => playTone(1100, 0.08, 'square', 0.08), 40);
        }
        function playDestroy() { playTone(150, 0.15, 'square', 0.08); }
        function playPowerup() {
            playTone(523, 0.08, 'square', 0.08);
            setTimeout(() => playTone(659, 0.08, 'square', 0.08), 60);
            setTimeout(() => playTone(784, 0.12, 'square', 0.08), 120);
        }
        function playWin() {
            [523, 659, 784, 1047].forEach((f, i) => setTimeout(() => playTone(f, 0.15, 'square', 0.08), i * 80));
        }
        function playLose() {
            [400, 350, 300, 250].forEach((f, i) => setTimeout(() => playTone(f, 0.15, 'square', 0.06), i * 120));
        }

        // ===== BACKGROUND MUSIC =====
        function initBackgroundMusic() {
            state.bgMusic = document.getElementById('bg-music');
            state.bgMusic.volume = 0.4;
        }

        function startBackgroundMusic() {
            if (!state.bgMusic || !state.musicEnabled || state.musicStarted) return;
            state.bgMusic.play().then(() => {
                state.musicStarted = true;
            }).catch(e => {
                // Autoplay blocked, will try again on next interaction
                console.log('Music autoplay blocked, waiting for interaction');
            });
        }

        function toggleBackgroundMusic() {
            state.musicEnabled = !state.musicEnabled;
            const icon = document.getElementById('music-icon');
            const text = document.getElementById('music-text');

            if (state.musicEnabled) {
                icon.textContent = '♪';
                text.textContent = 'ON';
                if (state.musicStarted) {
                    state.bgMusic.play();
                } else {
                    startBackgroundMusic();
                }
            } else {
                icon.textContent = '♪';
                text.textContent = 'OFF';
                state.bgMusic.pause();
            }
        }

        function pauseBackgroundMusic() {
            if (state.bgMusic && state.musicEnabled) {
                state.bgMusic.pause();
            }
        }

        function resumeBackgroundMusic() {
            if (state.bgMusic && state.musicEnabled && state.musicStarted) {
                state.bgMusic.play();
            }
        }

        // ===== MAZE GENERATION =====
        function generateMaze() {
            const { mazeWidth, mazeHeight, level } = state;
            
            // Initialize with walls
            state.maze = Array(mazeHeight).fill().map(() => Array(mazeWidth).fill(1));
            
            // Recursive backtracking
            function carve(x, y) {
                state.maze[y][x] = 0;
                const dirs = [
                    { dx: 0, dy: -2 },
                    { dx: 0, dy: 2 },
                    { dx: -2, dy: 0 },
                    { dx: 2, dy: 0 }
                ].sort(() => Math.random() - 0.5);
                
                for (const dir of dirs) {
                    const nx = x + dir.dx;
                    const ny = y + dir.dy;
                    if (nx > 0 && nx < mazeWidth - 1 && ny > 0 && ny < mazeHeight - 1 && state.maze[ny][nx] === 1) {
                        state.maze[y + dir.dy / 2][x + dir.dx / 2] = 0;
                        carve(nx, ny);
                    }
                }
            }
            
            carve(1, 1);
            
            // Ensure start and goal are open
            state.maze[1][1] = 0;
            state.maze[state.goal.y][state.goal.x] = 0;
            
            // Add some extra paths for easier navigation
            const extraPaths = 5; // Standard difficulty
            for (let i = 0; i < extraPaths; i++) {
                const x = Math.floor(Math.random() * (mazeWidth - 4)) + 2;
                const y = Math.floor(Math.random() * (mazeHeight - 4)) + 2;
                if (state.maze[y][x] === 1) {
                    state.maze[y][x] = 0;
                }
            }
            
            // Generate hazards
            const hazardCount = Math.min(3 + level, 7); // Standard difficulty
            state.hazards = [];
            for (let i = 0; i < hazardCount; i++) {
                let attempts = 0;
                while (attempts < 50) {
                    const hx = Math.floor(Math.random() * (mazeWidth - 2)) + 1;
                    const hy = Math.floor(Math.random() * (mazeHeight - 2)) + 1;
                    if (state.maze[hy][hx] === 0 && 
                        !(hx === 1 && hy === 1) && 
                        !(hx === state.goal.x && hy === state.goal.y) &&
                        !state.hazards.some(h => h.x === hx && h.y === hy)) {
                        state.hazards.push({ x: hx, y: hy, pulse: Math.random() * Math.PI * 2 });
                        break;
                    }
                    attempts++;
                }
            }
            
            // Generate collectibles
            const collectibleCount = 3 + Math.floor(level / 2);
            state.collectibles = [];
            for (let i = 0; i < collectibleCount; i++) {
                let attempts = 0;
                while (attempts < 50) {
                    const cx = Math.floor(Math.random() * (mazeWidth - 2)) + 1;
                    const cy = Math.floor(Math.random() * (mazeHeight - 2)) + 1;
                    if (state.maze[cy][cx] === 0 && 
                        !(cx === 1 && cy === 1) && 
                        !(cx === state.goal.x && cy === state.goal.y) &&
                        !state.hazards.some(h => h.x === cx && h.y === cy) &&
                        !state.collectibles.some(c => c.x === cx && c.y === cy)) {
                        state.collectibles.push({ x: cx, y: cy, rotation: Math.random() * Math.PI * 2 });
                        break;
                    }
                    attempts++;
                }
            }
            
            // Generate powerups
            state.powerups = [];
            if (Math.random() < 0.6) {
                let attempts = 0;
                while (attempts < 50) {
                    const px = Math.floor(Math.random() * (mazeWidth - 2)) + 1;
                    const py = Math.floor(Math.random() * (mazeHeight - 2)) + 1;
                    if (state.maze[py][px] === 0 && 
                        !(px === 1 && py === 1) && 
                        !(px === state.goal.x && py === state.goal.y) &&
                        !state.hazards.some(h => h.x === px && h.y === py) &&
                        !state.collectibles.some(c => c.x === px && c.y === py)) {
                        const type = Math.random() < 0.5 ? 'speed' : 'time';
                        state.powerups.push({ x: px, y: py, type, pulse: 0 });
                        break;
                    }
                    attempts++;
                }
            }
            
            // Verify maze is solvable
            if (!isSolvable()) {
                generateMaze();
            }
        }

        function isSolvable() {
            const visited = Array(state.mazeHeight).fill().map(() => Array(state.mazeWidth).fill(false));
            const queue = [{ x: 1, y: 1 }];
            visited[1][1] = true;
            
            while (queue.length > 0) {
                const { x, y } = queue.shift();
                if (x === state.goal.x && y === state.goal.y) return true;
                
                const dirs = [[0, -1], [0, 1], [-1, 0], [1, 0]];
                for (const [dx, dy] of dirs) {
                    const nx = x + dx;
                    const ny = y + dy;
                    if (nx >= 0 && nx < state.mazeWidth && ny >= 0 && ny < state.mazeHeight &&
                        !visited[ny][nx] && state.maze[ny][nx] === 0 &&
                        !state.hazards.some(h => h.x === nx && h.y === ny)) {
                        visited[ny][nx] = true;
                        queue.push({ x: nx, y: ny });
                    }
                }
            }
            return false;
        }

        // ===== PARTICLES (Game Boy Style - Simple Squares) =====
        function createParticles(x, y, color, count = 6) {
            for (let i = 0; i < count; i++) {
                const angle = (Math.PI * 2 / count) * i;
                const speed = 1.5 + Math.random() * 2;
                state.particles.push({
                    x: x * state.tileSize + state.tileSize / 2,
                    y: y * state.tileSize + state.tileSize / 2,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    life: 1,
                    color: state.gbColors.darkest,
                    size: 2 + Math.floor(Math.random() * 3)
                });
            }
        }

        function updateParticles() {
            state.particles = state.particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.15; // gravity
                p.life -= 0.05;
                p.vx *= 0.95;
                return p.life > 0;
            });
        }

        // ===== MOVEMENT =====
        function movePlayer(dx, dy) {
            if (state.gamePaused || state.gameOver || !state.gameStarted) return;
            if (state.player.animProgress < 1) return;
            
            const now = Date.now();
            const delay = state.speedBoost ? state.moveDelay * 0.5 : state.moveDelay;
            if (now - state.lastMoveTime < delay) return;
            
            const nx = state.player.targetX + dx;
            const ny = state.player.targetY + dy;
            
            if (nx >= 0 && nx < state.mazeWidth && ny >= 0 && ny < state.mazeHeight && state.maze[ny][nx] === 0) {
                // Check hazard
                if (state.hazards.some(h => h.x === nx && h.y === ny)) {
                    const canvas = document.getElementById('game-canvas');
                    canvas.classList.add('shake');
                    setTimeout(() => canvas.classList.remove('shake'), 300);
                    return;
                }
                
                state.player.targetX = nx;
                state.player.targetY = ny;
                state.player.animProgress = 0;
                state.lastMoveTime = now;
                playMove();
                
                // Check collectibles
                const collectIdx = state.collectibles.findIndex(c => c.x === nx && c.y === ny);
                if (collectIdx !== -1) {
                    state.collectibles.splice(collectIdx, 1);
                    
                    // Combo system
                    if (now - state.lastCollectTime < 2000) {
                        state.combo = Math.min(state.combo + 1, 5);
                    } else {
                        state.combo = 1;
                    }
                    state.lastCollectTime = now;
                    state.comboTimer = 60;
                    
                    const points = 10 * state.combo;
                    state.score += points;
                    createParticles(nx, ny, '#FFD700', 12);
                    playCollect();
                    updateUI();
                }
                
                // Check powerups
                const powerIdx = state.powerups.findIndex(p => p.x === nx && p.y === ny);
                if (powerIdx !== -1) {
                    const power = state.powerups[powerIdx];
                    state.powerups.splice(powerIdx, 1);
                    
                    if (power.type === 'speed') {
                        state.speedBoost = true;
                        state.speedBoostTimer = 300; // 5 seconds
                        document.getElementById('speed-indicator').classList.remove('hidden');
                    } else if (power.type === 'time') {
                        state.timeLeft += 10;
                    }
                    
                    createParticles(nx, ny, power.type === 'speed' ? '#FFD700' : '#00FFFF', 15);
                    playPowerup();
                    updateUI();
                }
                
                // Check goal
                if (nx === state.goal.x && ny === state.goal.y) {
                    levelComplete();
                }
            }
        }

        function destroyHazard() {
            if (state.gamePaused || state.gameOver || !state.gameStarted) return;
            
            const { targetX, targetY } = state.player;
            const adjacent = [
                { x: targetX, y: targetY },
                { x: targetX + 1, y: targetY },
                { x: targetX - 1, y: targetY },
                { x: targetX, y: targetY + 1 },
                { x: targetX, y: targetY - 1 }
            ];
            
            for (const pos of adjacent) {
                const idx = state.hazards.findIndex(h => h.x === pos.x && h.y === pos.y);
                if (idx !== -1) {
                    const hazard = state.hazards[idx];
                    state.hazards.splice(idx, 1);
                    state.score += 5;
                    createParticles(hazard.x, hazard.y, '#FF4444', 15);
                    playDestroy();
                    updateUI();
                    return;
                }
            }
        }

        // ===== GAME FLOW =====
        function levelComplete() {
            const timeBonus = state.timeLeft * 2;
            state.score += timeBonus;
            
            document.getElementById('level-bonus').textContent = timeBonus;
            document.getElementById('level-complete').classList.remove('hidden');
            playWin();
            
            let countdown = 3;
            const timerEl = document.getElementById('next-level-timer');
            const interval = setInterval(() => {
                countdown--;
                timerEl.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(interval);
                    document.getElementById('level-complete').classList.remove('hidden');
                    nextLevel();
                }
            }, 1000);
        }

        function nextLevel() {
            state.level++;
            state.player = { x: 1, y: 1, targetX: 1, targetY: 1, animProgress: 1 };
            state.timeLeft = Math.max(30, 60 - state.level * 2); // Less time each level
            state.speedBoost = false;
            state.speedBoostTimer = 0;
            document.getElementById('speed-indicator').classList.add('hidden');
            
            generateMaze();
            document.getElementById('level-complete').classList.add('hidden');
            updateUI();
        }

        function gameOverScreen(won) {
            state.gameOver = true;
            state.gameStarted = false;

            if (!won) playLose();

            const isNewHighScore = state.score > state.highScore;
            if (isNewHighScore) {
                state.highScore = state.score;
                localStorage.setItem('mazeHighScore', state.score.toString());
            }

            // Add score to leaderboard
            if (state.score > 0) {
                addToLeaderboard(state.playerName, state.score, state.level);
            }

            document.getElementById('game-over-title').textContent = won ? 'Victory!' : "Time's Up!";
            document.getElementById('final-score').textContent = state.score;
            document.getElementById('final-level').textContent = state.level;
            document.getElementById('new-high-score').classList.toggle('hidden', !isNewHighScore);
            document.getElementById('game-over').classList.remove('hidden');
        }

        function startGame() {
            state.gameStarted = false;
            state.gameOver = false;
            state.gamePaused = false;
            state.score = 0;
            state.level = 1;
            state.combo = 0;
            state.timeLeft = 60;
            state.player = { x: 1, y: 1, targetX: 1, targetY: 1, animProgress: 1 };
            state.speedBoost = false;
            state.particles = [];

            // Start background music on first game start
            startBackgroundMusic();

            generateMaze();
            
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-over').classList.add('hidden');
            document.getElementById('speed-indicator').classList.add('hidden');
            
            updateUI();
            
            // Countdown
            const countdownEl = document.getElementById('countdown');
            countdownEl.classList.remove('hidden');
            let count = 3;
            countdownEl.querySelector('span').textContent = count;
            
            const countInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownEl.querySelector('span').textContent = count;
                    playTone(440, 0.1, 'sine', 0.1);
                } else {
                    countdownEl.classList.add('hidden');
                    playTone(880, 0.2, 'sine', 0.15);
                    state.gameStarted = true;
                    clearInterval(countInterval);
                }
            }, 1000);
        }

        function updateUI() {
            // Format score with leading zeros (GB style)
            const scoreStr = String(state.score).padStart(4, '0');
            document.getElementById('score').textContent = `SC:${scoreStr}`;

            // Timer
            const timerEl = document.getElementById('timer');
            timerEl.textContent = `T:${String(state.timeLeft).padStart(2, '0')}`;
            // Flash when low time
            if (state.timeLeft <= 10) {
                timerEl.classList.add('blink');
            } else {
                timerEl.classList.remove('blink');
            }

            // Level with leading zero
            document.getElementById('level').textContent = `LV:${String(state.level).padStart(2, '0')}`;

            // Combo indicator
            const comboEl = document.getElementById('combo');
            if (state.combo > 1) {
                comboEl.textContent = `x${state.combo}!`;
                comboEl.classList.remove('hidden');
            } else {
                comboEl.classList.add('hidden');
            }
        }

        // ===== RENDERING (Game Boy Style) =====
        function draw() {
            const { ctx, canvas, tileSize, maze, mazeWidth, mazeHeight, player, goal, hazards, collectibles, powerups, particles, gbColors } = state;

            // Clear with lightest GB color
            ctx.fillStyle = gbColors.lightest;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw maze with GB colors
            for (let y = 0; y < mazeHeight; y++) {
                for (let x = 0; x < mazeWidth; x++) {
                    if (maze[y][x] === 1) {
                        // Wall - darkest color with simple block pattern
                        ctx.fillStyle = gbColors.darkest;
                        ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
                        // Inner highlight for depth
                        ctx.fillStyle = gbColors.dark;
                        ctx.fillRect(x * tileSize + 2, y * tileSize + 2, tileSize - 4, tileSize - 4);
                    } else {
                        // Floor - light color
                        ctx.fillStyle = gbColors.light;
                        ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
                        // Grid lines for retro look
                        ctx.strokeStyle = gbColors.lightest;
                        ctx.lineWidth = 1;
                        ctx.strokeRect(x * tileSize, y * tileSize, tileSize, tileSize);
                    }
                }
            }

            // Draw goal - pulsing flag pattern
            const goalPulse = Math.floor(Date.now() / 300) % 2;
            ctx.fillStyle = goalPulse ? gbColors.dark : gbColors.darkest;
            ctx.fillRect(goal.x * tileSize + 2, goal.y * tileSize + 2, tileSize - 4, tileSize - 4);
            // Draw 'F' for flag/finish
            ctx.fillStyle = gbColors.lightest;
            ctx.font = `bold ${tileSize * 0.6}px 'Press Start 2P', monospace`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('F', goal.x * tileSize + tileSize / 2, goal.y * tileSize + tileSize / 2);

            // Draw hazards - skull/X pattern
            hazards.forEach(h => {
                h.pulse += 0.1;
                const flash = Math.floor(h.pulse) % 2;
                ctx.fillStyle = flash ? gbColors.darkest : gbColors.dark;
                ctx.fillRect(h.x * tileSize + 3, h.y * tileSize + 3, tileSize - 6, tileSize - 6);
                // Draw X for hazard
                ctx.fillStyle = gbColors.lightest;
                ctx.font = `bold ${tileSize * 0.5}px 'Press Start 2P', monospace`;
                ctx.fillText('X', h.x * tileSize + tileSize / 2, h.y * tileSize + tileSize / 2);
            });

            // Draw collectibles - gem/star pattern
            collectibles.forEach(c => {
                c.rotation += 0.08;
                const bob = Math.floor(c.rotation) % 2 ? 1 : -1;
                ctx.fillStyle = gbColors.dark;
                ctx.fillRect(c.x * tileSize + 4, c.y * tileSize + 4 + bob, tileSize - 8, tileSize - 8);
                // Draw * for gem
                ctx.fillStyle = gbColors.lightest;
                ctx.font = `bold ${tileSize * 0.5}px 'Press Start 2P', monospace`;
                ctx.fillText('*', c.x * tileSize + tileSize / 2, c.y * tileSize + tileSize / 2 + bob);
            });

            // Draw powerups
            powerups.forEach(p => {
                p.pulse += 0.1;
                const scale = Math.floor(p.pulse) % 2;
                const offset = scale ? 2 : 4;
                ctx.fillStyle = gbColors.dark;
                ctx.fillRect(p.x * tileSize + offset, p.y * tileSize + offset, tileSize - offset * 2, tileSize - offset * 2);
                // Draw ! for powerup
                ctx.fillStyle = gbColors.lightest;
                ctx.font = `bold ${tileSize * 0.45}px 'Press Start 2P', monospace`;
                const icon = p.type === 'speed' ? '!' : '+';
                ctx.fillText(icon, p.x * tileSize + tileSize / 2, p.y * tileSize + tileSize / 2);
            });

            // Draw particles - simple squares
            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = gbColors.darkest;
                const size = Math.max(2, Math.floor(p.size * p.life));
                ctx.fillRect(Math.floor(p.x), Math.floor(p.y), size, size);
            });
            ctx.globalAlpha = 1;

            // Animate player
            if (player.animProgress < 1) {
                player.animProgress += 0.2;
                if (player.animProgress > 1) player.animProgress = 1;

                const ease = 1 - Math.pow(1 - player.animProgress, 3);
                player.x = player.x + (player.targetX - player.x) * ease;
                player.y = player.y + (player.targetY - player.y) * ease;
            } else {
                player.x = player.targetX;
                player.y = player.targetY;
            }

            // Draw player - character symbol
            const px = Math.floor(player.x * tileSize);
            const py = Math.floor(player.y * tileSize);

            // Player background
            ctx.fillStyle = gbColors.darkest;
            ctx.fillRect(px + 2, py + 2, tileSize - 4, tileSize - 4);

            // Player character
            ctx.fillStyle = gbColors.lightest;
            ctx.font = `bold ${tileSize * 0.6}px 'Press Start 2P', monospace`;
            ctx.fillText(state.character, px + tileSize / 2, py + tileSize / 2);

            // Speed boost effect - flashing border
            if (state.speedBoost) {
                const flash = Math.floor(Date.now() / 100) % 2;
                if (flash) {
                    ctx.strokeStyle = gbColors.darkest;
                    ctx.lineWidth = 2;
                    ctx.strokeRect(px, py, tileSize, tileSize);
                }
            }
        }

        // ===== GAME LOOP =====
        let lastTime = 0;
        let timerAccum = 0;
        
        function gameLoop(timestamp) {
            const delta = timestamp - lastTime;
            lastTime = timestamp;
            
            if (state.gameStarted && !state.gamePaused && !state.gameOver) {
                // Timer
                timerAccum += delta;
                if (timerAccum >= 1000) {
                    timerAccum -= 1000;
                    state.timeLeft--;
                    updateUI();
                    
                    if (state.timeLeft <= 0) {
                        gameOverScreen(false);
                    }
                }
                
                // Combo timer
                if (state.comboTimer > 0) {
                    state.comboTimer--;
                    if (state.comboTimer <= 0) {
                        state.combo = 0;
                        updateUI();
                    }
                }
                
                // Speed boost timer
                if (state.speedBoost) {
                    state.speedBoostTimer--;
                    if (state.speedBoostTimer <= 0) {
                        state.speedBoost = false;
                        document.getElementById('speed-indicator').classList.add('hidden');
                    }
                }
                
                // Handle held keys
                const now = Date.now();
                const delay = state.speedBoost ? state.moveDelay * 0.5 : state.moveDelay;
                if (now - state.lastMoveTime >= delay) {
                    if (state.keysPressed['ArrowUp'] || state.keysPressed['KeyW']) movePlayer(0, -1);
                    else if (state.keysPressed['ArrowDown'] || state.keysPressed['KeyS']) movePlayer(0, 1);
                    else if (state.keysPressed['ArrowLeft'] || state.keysPressed['KeyA']) movePlayer(-1, 0);
                    else if (state.keysPressed['ArrowRight'] || state.keysPressed['KeyD']) movePlayer(1, 0);
                }
                
                updateParticles();
                draw();
            }
            
            requestAnimationFrame(gameLoop);
        }

        // ===== INPUT =====
        function setupInput() {
            document.addEventListener('keydown', (e) => {
                if (!state.audioCtx) initAudio();

                state.keysPressed[e.code] = true;

                if (e.code === 'Space') {
                    e.preventDefault();
                    destroyHazard();
                }

                if (e.code === 'KeyP' || e.code === 'Escape') {
                    e.preventDefault();
                    togglePause();
                }

                // Prevent scrolling
                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Space'].includes(e.code)) {
                    e.preventDefault();
                }
            });

            document.addEventListener('keyup', (e) => {
                state.keysPressed[e.code] = false;
            });

            // D-Pad and action buttons on the GameyBoy device
            document.querySelectorAll('.mobile-btn').forEach(btn => {
                const dir = btn.dataset.dir;
                if (!dir) return;

                const doMove = () => {
                    if (!state.audioCtx) initAudio();
                    if (dir === 'up') movePlayer(0, -1);
                    else if (dir === 'down') movePlayer(0, 1);
                    else if (dir === 'left') movePlayer(-1, 0);
                    else if (dir === 'right') movePlayer(1, 0);
                    else if (dir === 'action') destroyHazard();
                };

                const startHold = (e) => {
                    e.preventDefault();
                    if (!state.audioCtx) initAudio();
                    doMove();
                    // For directional buttons, enable hold-to-move
                    if (['up', 'down', 'left', 'right'].includes(dir)) {
                        if (state.touchHoldInterval) clearInterval(state.touchHoldInterval);
                        state.touchHoldInterval = setInterval(doMove, 100);
                    }
                };

                const endHold = (e) => {
                    e.preventDefault();
                    if (state.touchHoldInterval) {
                        clearInterval(state.touchHoldInterval);
                        state.touchHoldInterval = null;
                    }
                };

                btn.addEventListener('touchstart', startHold, { passive: false });
                btn.addEventListener('touchend', endHold, { passive: false });
                btn.addEventListener('touchcancel', endHold, { passive: false });
                btn.addEventListener('mousedown', startHold);
                btn.addEventListener('mouseup', endHold);
                btn.addEventListener('mouseleave', endHold);
            });

            // B Button - destroy hazard
            const btnB = document.getElementById('btn-b');
            if (btnB) {
                const handleB = (e) => {
                    e.preventDefault();
                    if (!state.audioCtx) initAudio();
                    destroyHazard();
                };
                btnB.addEventListener('click', handleB);
                btnB.addEventListener('touchstart', handleB, { passive: false });
            }

            // A Button - could be used for future features, for now same as B
            const btnA = document.getElementById('btn-a');
            if (btnA) {
                const handleA = (e) => {
                    e.preventDefault();
                    if (!state.audioCtx) initAudio();
                    // A button can be confirm/action
                    destroyHazard();
                };
                btnA.addEventListener('click', handleA);
                btnA.addEventListener('touchstart', handleA, { passive: false });
            }

            // SELECT button - pause
            const selectBtn = document.getElementById('select-btn');
            if (selectBtn) {
                const handleSelect = (e) => {
                    e.preventDefault();
                    if (!state.audioCtx) initAudio();
                    togglePause();
                };
                selectBtn.addEventListener('click', handleSelect);
                selectBtn.addEventListener('touchstart', handleSelect, { passive: false });
            }

            // START button - start game or unpause
            const startGameBtn = document.getElementById('start-game-btn');
            if (startGameBtn) {
                const handleStart = (e) => {
                    e.preventDefault();
                    if (!state.audioCtx) initAudio();
                    if (state.gamePaused) {
                        togglePause();
                    } else if (!state.gameStarted && !document.getElementById('menu-screen').classList.contains('hidden')) {
                        startGame();
                    }
                };
                startGameBtn.addEventListener('click', handleStart);
                startGameBtn.addEventListener('touchstart', handleStart, { passive: false });
            }
        }

        function togglePause() {
            if (state.gameStarted && !state.gameOver) {
                state.gamePaused = !state.gamePaused;
                document.getElementById('pause-overlay').classList.toggle('hidden', !state.gamePaused);
                if (state.gamePaused) {
                    pauseBackgroundMusic();
                    if (state.touchHoldInterval) {
                        clearInterval(state.touchHoldInterval);
                        state.touchHoldInterval = null;
                    }
                } else {
                    resumeBackgroundMusic();
                }
            }
        }

        // ===== SETUP =====
        function calculateTileSize() {
            // Adjust for GameyBoy device frame - screen area is smaller
            const deviceWidth = Math.min(window.innerWidth - 16, 400);
            const screenWidth = deviceWidth - 70; // Account for bezel padding
            const screenHeight = 240; // Fixed height for LCD screen area

            const maxTileW = Math.floor(screenWidth / state.mazeWidth);
            const maxTileH = Math.floor(screenHeight / state.mazeHeight);
            return Math.min(Math.max(Math.min(maxTileW, maxTileH), 14), 20);
        }

        function resizeCanvas() {
            state.tileSize = calculateTileSize();
            state.canvas.width = state.mazeWidth * state.tileSize;
            state.canvas.height = state.mazeHeight * state.tileSize;
            if (state.gameStarted && !state.gamePaused && !state.gameOver) {
                draw();
            }
        }

        function setup() {
            state.canvas = document.getElementById('game-canvas');
            state.ctx = state.canvas.getContext('2d');
            state.isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            state.tileSize = calculateTileSize();
            state.canvas.width = state.mazeWidth * state.tileSize;
            state.canvas.height = state.mazeHeight * state.tileSize;

            // Handle resize
            window.addEventListener('resize', resizeCanvas);

            // Load leaderboard
            loadLeaderboard();

            document.getElementById('high-score').textContent = state.highScore;

            // Initialize background music
            initBackgroundMusic();

            // Name entry screen
            const nameInput = document.getElementById('player-name-input');
            const startBtn = document.getElementById('start-btn');

            // Check if player name is saved
            const savedName = localStorage.getItem('mazePlayerName');
            if (savedName) {
                nameInput.value = savedName;
            }

            startBtn.addEventListener('click', () => {
                const name = nameInput.value.trim() || 'Player';
                state.playerName = name;
                localStorage.setItem('mazePlayerName', name);
                document.getElementById('player-name-display').textContent = name;
                document.getElementById('name-screen').classList.add('hidden');
                document.getElementById('menu-screen').classList.remove('hidden');
                if (!state.audioCtx) initAudio();
            });

            nameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    startBtn.click();
                }
            });

            // Music toggle button
            document.getElementById('music-toggle').addEventListener('click', () => {
                if (!state.musicStarted) startBackgroundMusic();
                toggleBackgroundMusic();
            });

            // Leaderboard buttons
            document.getElementById('leaderboard-btn').addEventListener('click', showLeaderboard);
            document.getElementById('gameover-leaderboard-btn').addEventListener('click', showLeaderboard);
            document.getElementById('close-leaderboard-btn').addEventListener('click', hideLeaderboard);

            // Character selection (using symbol mapping)
            document.querySelectorAll('#characters button').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (!state.audioCtx) initAudio();
                    playTone(600, 0.05, 'square', 0.05);
                    const charKey = btn.dataset.char;
                    state.character = state.characterMap[charKey] || '@';
                    document.querySelectorAll('#characters button').forEach(b => {
                        b.style.background = '#8bac0f';
                    });
                    btn.style.background = '#306230';
                });
            });
            
            // Play button
            document.getElementById('play-btn').addEventListener('click', startGame);
            
            // Game over buttons
            document.getElementById('play-again-btn').addEventListener('click', startGame);
            document.getElementById('menu-btn').addEventListener('click', () => {
                document.getElementById('game-over').classList.add('hidden');
                document.getElementById('game-screen').classList.add('hidden');
                document.getElementById('menu-screen').classList.remove('hidden');
                document.getElementById('high-score').textContent = state.highScore;
            });
            
            // Pause buttons
            document.getElementById('resume-btn').addEventListener('click', () => {
                state.gamePaused = false;
                document.getElementById('pause-overlay').classList.add('hidden');
                resumeBackgroundMusic();
            });
            document.getElementById('quit-btn').addEventListener('click', () => {
                // Save score to leaderboard before quitting
                if (state.score > 0) {
                    addToLeaderboard(state.playerName, state.score, state.level);
                }
                state.gamePaused = false;
                state.gameStarted = false;
                document.getElementById('pause-overlay').classList.add('hidden');
                document.getElementById('game-screen').classList.add('hidden');
                document.getElementById('menu-screen').classList.remove('hidden');
                // Music keeps playing in menu
                resumeBackgroundMusic();
            });
            
            setupInput();
            requestAnimationFrame(gameLoop);
        }

        // Start
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setup);
        } else {
            setup();
        }
    </script>
</body>
</html>
